<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="WeAir"><link rel="alternative" href="/atom.xml" title="WeAir" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><title>源码安装GitLab - WeAir</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">WeAir</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">カタログ/（目录）</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time class="post__time" datetime="2020-03-04T04:00:00.000Z">March 4, 2020</time><h1 class="post__title"><a href="/install-gitlab/">源码安装GitLab</a></h1><div class="post__main echo"><p><a href="https://about.gitlab.com/" title="GitLab" target="_blank" rel="noopener">GitLab</a>是由GitLab Inc.开发，使用MIT许可证的基于网络的Git仓库管理工具，且具有wiki和issue跟踪功能。</p>
<h3 id="安装要求"><a href="#安装要求" class="headerlink" title="安装要求"></a>安装要求</h3><p>系统为Ubuntu 20，内存至少4G，建议增加Swap交换分区解决内存不足等问题。</p>
<h3 id="1-安装软件包及依赖"><a href="#1-安装软件包及依赖" class="headerlink" title="1.安装软件包及依赖"></a>1.安装软件包及依赖</h3><p>安装vim编辑器并设置为默认编辑器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y vim</span><br><span class="line">sudo update-alternatives --<span class="built_in">set</span> editor /usr/bin/vim.basic</span><br></pre></td></tr></table></figure>

<p>安装依赖</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y build-essential zlib1g-dev libyaml-dev libssl-dev libgdbm-dev libre2-dev libreadline-dev libncurses5-dev libffi-dev curl openssh-server libxml2-dev libxslt-dev libcurl4-openssl-dev libicu-dev logrotate rsync python-docutils pkg-config cmake runit-systemd</span><br></pre></td></tr></table></figure>

<p>从GitLab13.6起，需要安装Gitaly提供的Git。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y libcurl4-openssl-dev libexpat1-dev gettext libz-dev libssl-dev libpcre2-dev build-essential git-core</span><br><span class="line">git <span class="built_in">clone</span> https://gitlab.com/gitlab-org/gitaly.git -b &lt;X-Y-stable&gt; /tmp/gitaly</span><br><span class="line"><span class="built_in">cd</span> /tmp/gitaly</span><br><span class="line">sudo make git GIT_PREFIX=/usr/<span class="built_in">local</span></span><br></pre></td></tr></table></figure>

<p>为了使自定义图标能够正常工作，需要安装GraphicsMagick。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y graphicsmagick</span><br></pre></td></tr></table></figure>

<p>为了接收邮件通知，需要安装postfix。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y postfix</span><br></pre></td></tr></table></figure>

<h3 id="2-Ruby"><a href="#2-Ruby" class="headerlink" title="2.Ruby"></a>2.Ruby</h3><p>运行GitLab需要使用Ruby，需要安装Ruby。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 下载Ruby源码并编译安装</span></span><br><span class="line">mkdir /tmp/ruby &amp;&amp; <span class="built_in">cd</span> /tmp/ruby</span><br><span class="line">curl --remote-name --progress-bar <span class="string">"https://cache.ruby-lang.org/pub/ruby/2.7/ruby-2.7.4.tar.gz"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'3043099089608859fc8cce7f9fdccaa1f53a462457e3838ec3b25a7d609fbc5b ruby-2.7.4.tar.gz'</span> | sha256sum -c - &amp;&amp; tar xzf ruby-2.7.4.tar.gz</span><br><span class="line"><span class="built_in">cd</span> ruby-2.7.4</span><br><span class="line">./configure --<span class="built_in">disable</span>-install-rdoc --<span class="built_in">enable</span>-shared</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<h3 id="3-Go"><a href="#3-Go" class="headerlink" title="3.Go"></a>3.Go</h3><p>GitLab有几个用Go编写的守护程序。要安装GitLab，需要一个Go编译器。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果有旧的Go编译器的话，需要先移除掉旧版本</span></span><br><span class="line">sudo rm -rf /usr/<span class="built_in">local</span>/go</span><br><span class="line"></span><br><span class="line">curl --remote-name --progress-bar <span class="string">"https://golang.org/dl/go1.16.9.linux-amd64.tar.gz"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'d2c095c95f63c2a3ef961000e0ecb9d81d5c68b6ece176e2a8a2db82dc02931c'</span> go1.16.9.linux-amd64.tar.gz<span class="string">' | shasum -a256 -c - &amp;&amp; sudo tar -C /usr/local -xzf go1.15.12.linux-amd64.tar.gz</span></span><br><span class="line"><span class="string">sudo ln -sf /usr/local/go/bin/&#123;go,godoc,gofmt&#125; /usr/local/bin/</span></span><br><span class="line"><span class="string">rm go1.16.9.linux-amd64.tar.gz</span></span><br></pre></td></tr></table></figure>

<h3 id="4-Node"><a href="#4-Node" class="headerlink" title="4.Node"></a>4.Node</h3><p>GitLab需要使用Node来编译JavaScript，并使用Yarn来管理JavaScript依赖。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装node v14.x</span></span><br><span class="line">curl --location <span class="string">"https://deb.nodesource.com/setup_14.x"</span> | sudo bash -</span><br><span class="line">sudo apt-get install -y nodejs</span><br><span class="line"></span><br><span class="line">npm install --global yarn</span><br></pre></td></tr></table></figure>

<h3 id="5-添加GitLab用户"><a href="#5-添加GitLab用户" class="headerlink" title="5.添加GitLab用户"></a>5.添加GitLab用户</h3><p>为GitLab创建一个<strong>git</strong>用户。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo adduser --disabled-login --gecos <span class="string">'GitLab'</span> git</span><br></pre></td></tr></table></figure>

<h3 id="6-数据库"><a href="#6-数据库" class="headerlink" title="6.数据库"></a>6.数据库</h3><p>创建PostgreSQL数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y postgresql postgresql-client libpq-dev postgresql-contrib</span><br></pre></td></tr></table></figure>

<p>启动PostgreSQL数据库并查看状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo service postgresql start</span><br><span class="line">sudo service postgresql status</span><br></pre></td></tr></table></figure>

<p>为GitLab创建数据库用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u postgres psql -d template1 -c <span class="string">"CREATE USER git CREATEDB;"</span></span><br></pre></td></tr></table></figure>

<p>创建<strong>pg_trgm</strong>扩展</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u postgres psql -d template1 -c <span class="string">"CREATE EXTENSION IF NOT EXISTS pg_trgm;"</span></span><br></pre></td></tr></table></figure>

<p>创建<strong>btree_gist</strong>扩展</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u postgres psql -d template1 -c <span class="string">"CREATE EXTENSION IF NOT EXISTS btree_gist;"</span></span><br></pre></td></tr></table></figure>

<p>创建数据库并赋予用户权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u postgres psql -d template1 -c <span class="string">"CREATE DATABASE gitlabhq_production OWNER git;"</span></span><br></pre></td></tr></table></figure>

<p>尝试使用git用户连接数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u git -H psql -d gitlabhq_production</span><br></pre></td></tr></table></figure>

<p>检查扩展<strong>pg_trgm</strong>是否生效</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT <span class="literal">true</span> AS enabled</span><br><span class="line">FROM pg_available_extensions</span><br><span class="line">WHERE name = <span class="string">'pg_trgm'</span></span><br><span class="line">AND installed_version IS NOT NULL;</span><br></pre></td></tr></table></figure>

<p>如果扩展生效，则显示以下内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">enabled</span><br><span class="line">---------</span><br><span class="line"> t</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>

<p>检查扩展<strong>btree_gist</strong>是否生效</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT <span class="literal">true</span> AS enabled</span><br><span class="line">FROM pg_available_extensions</span><br><span class="line">WHERE name = <span class="string">'btress_gist'</span></span><br><span class="line">AND installed_version IS NOT NULL;</span><br></pre></td></tr></table></figure>

<p>如果扩展生效，则显示以下内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">enabled</span><br><span class="line">---------</span><br><span class="line"> t</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>

<p>退出数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlabhq_production&gt; \q</span><br></pre></td></tr></table></figure>

<p>修改Postgresql的配置文件允许机器访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/postgresql/12/main/pg_hba.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改文件末尾处</span></span><br><span class="line"><span class="comment"># "local" is for Unix domain socket connections only</span></span><br><span class="line"><span class="built_in">local</span>   all             all                                     trust</span><br><span class="line"><span class="comment"># IPv4 local connections:</span></span><br><span class="line">host    all             all             127.0.0.1/32            trust</span><br><span class="line"><span class="comment"># IPv6 local connections:</span></span><br><span class="line">host    all             all             ::1/128                 trust</span><br></pre></td></tr></table></figure>

<p>重启PostgreSQL服务。</p>
<h3 id="7-Redis"><a href="#7-Redis" class="headerlink" title="7.Redis"></a>7.Redis</h3><p>GitLab需要安装Redis。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install redis-server</span><br></pre></td></tr></table></figure>

<p>配置Redis</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /etc/redis/redis.conf /etc/redis/redis.conf.orig</span><br><span class="line"></span><br><span class="line">sudo sed <span class="string">'s/^port .*/port 0/'</span> /etc/redis/redis.conf.orig | sudo tee /etc/redis/redis.conf</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'unixsocket /var/run/redis/redis.sock'</span> | sudo tee -a /etc/redis/redis.conf</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'unixsocketperm 770'</span> | sudo tee -a /etc/redis/redis.conf</span><br><span class="line"></span><br><span class="line">sudo mkdir -p /var/run/redis</span><br><span class="line">sudo chown redis:redis /var/run/redis</span><br><span class="line">sudo chmod 755 /var/run/redis</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -d /etc/tmpfiles.d ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">'d  /var/run/redis  0755  redis  redis  10d  -'</span> | sudo tee -a /etc/tmpfiles.d/redis.conf</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">sudo service redis-server restart</span><br><span class="line"></span><br><span class="line">sudo usermod -aG redis git</span><br></pre></td></tr></table></figure>

<h3 id="8-GitLab"><a href="#8-GitLab" class="headerlink" title="8.GitLab"></a>8.GitLab</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在git的home目录安装GitLab</span></span><br><span class="line"><span class="built_in">cd</span> /home/git</span><br></pre></td></tr></table></figure>

<p>下载GitLab源码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u git -H git <span class="built_in">clone</span> https://gitlab.com/gitlab-org/gitlab-foss.git -b 14-3-stable gitlab</span><br></pre></td></tr></table></figure>

<p>配置GitLab</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/git/gitlab</span><br><span class="line"></span><br><span class="line">sudo -u git -H cp config/gitlab.yml.example config/gitlab.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑gitlab.yml修改域名、是否使用HTTPS以及git路径，修改以下配置</span></span><br><span class="line">sudo -u git -H editor config/gitlab.yml</span><br><span class="line"></span><br><span class="line">gitlab:</span><br><span class="line">  host: domain.name</span><br><span class="line">  port: 443 <span class="comment"># Set to 443 if using HTTPS, see installation.md#using-https for additional HTTPS configuration details</span></span><br><span class="line">  https: <span class="literal">true</span> <span class="comment"># Set to true if using HTTPS, see installation.md#using-https for additional HTTPS configuration details</span></span><br><span class="line">...</span><br><span class="line">git:</span><br><span class="line">  bin_path: /usr/<span class="built_in">local</span>/bin/git</span><br><span class="line"></span><br><span class="line">sudo -u git -H cp config/secrets.yml.example config/secrets.yml</span><br><span class="line">sudo -u git -H chmod 0600 config/secrets.yml</span><br><span class="line"></span><br><span class="line">sudo chown -R git <span class="built_in">log</span>/</span><br><span class="line">sudo chown -R git tmp/</span><br><span class="line">sudo chmod -R u+rwX,go-w <span class="built_in">log</span>/</span><br><span class="line">sudo chmod -R u+rwX tmp/</span><br><span class="line"></span><br><span class="line">sudo chmod -R u+rwX tmp/pids/</span><br><span class="line">sudo chmod -R u+rwX tmp/sockets/</span><br><span class="line"></span><br><span class="line">sudo -u git -H mkdir -p public/uploads/</span><br><span class="line"></span><br><span class="line">sudo chmod 0700 public/uploads</span><br><span class="line"></span><br><span class="line">sudo chmod -R u+rwX builds/</span><br><span class="line"></span><br><span class="line">sudo chmod -R u+rwX shared/artifacts/</span><br><span class="line"></span><br><span class="line">sudo chmod -R ug+rwX shared/pages/</span><br><span class="line"></span><br><span class="line">sudo -u git -H cp config/puma.rb.example config/puma.rb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置Git全局配置</span></span><br><span class="line">sudo -u git -H git config --global core.autocrlf input</span><br><span class="line"></span><br><span class="line">sudo -u git -H git config --global gc.auto 0</span><br><span class="line"></span><br><span class="line">sudo -u git -H git config --global repack.writeBitmaps <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">sudo -u git -H git config --global receive.advertisePushOptions <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">sudo -u git -H git config --global core.fsyncObjectFiles <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">sudo -u git -H cp config/resque.yml.example config/resque.yml</span><br></pre></td></tr></table></figure>

<p>配置GitLab数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sudo -u git cp config/database.yml.postgresql config/database.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改数据库配置，把secure password改成你自己的密码。</span></span><br><span class="line">sudo -u git -H editor config/database.yml</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># PRODUCTION</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">production:</span><br><span class="line">  adapter: postgresql</span><br><span class="line">  encoding: unicode</span><br><span class="line">  database: gitlabhq_production</span><br><span class="line">  username: git</span><br><span class="line">  password: <span class="string">"yourpassword"</span></span><br><span class="line">  host: localhost</span><br><span class="line"></span><br><span class="line">sudo -u git -H chmod o-rwx config/database.yml</span><br></pre></td></tr></table></figure>

<p>安装Gems，确保bundle的版本大于等于1.5.2小于2.X。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo -u git -H bundle config <span class="built_in">set</span> --<span class="built_in">local</span> deployment <span class="string">'true'</span></span><br><span class="line">sudo -u git -H bundle config <span class="built_in">set</span> --<span class="built_in">local</span> without <span class="string">'development test mysql aws kerberos'</span></span><br><span class="line">sudo -u git -H bundle install</span><br></pre></td></tr></table></figure>

<p>安装GitLab Shell</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u git -H bundle <span class="built_in">exec</span> rake gitlab:shell:install RAILS_ENV=production</span><br></pre></td></tr></table></figure>

<p>安装GitLab Workhorse</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u git -H bundle <span class="built_in">exec</span> rake <span class="string">"gitlab:workhorse:install[/home/git/gitlab-workhorse]"</span> RAILS_ENV=production</span><br></pre></td></tr></table></figure>

<p>安装GitLab Pages</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/git</span><br><span class="line">sudo -u git -H git <span class="built_in">clone</span> https://gitlab.com/gitlab-org/gitlab-pages.git</span><br><span class="line"><span class="built_in">cd</span> gitlab-pages</span><br><span class="line">sudo -u git -H git checkout v$(&lt;/home/git/gitlab/GITLAB_PAGES_VERSION)</span><br><span class="line">sudo -u git -H make</span><br></pre></td></tr></table></figure>

<p>安装Gitaly</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/git/gitlab</span><br><span class="line">sudo -u git -H bundle <span class="built_in">exec</span> rake <span class="string">"gitlab:gitaly:install[/home/git/gitaly,/home/git/repositories]"</span> RAILS_ENV=production</span><br><span class="line"></span><br><span class="line">sudo chmod 0700 /home/git/gitlab/tmp/sockets/private</span><br><span class="line">sudo chown git /home/git/gitlab/tmp/sockets/private</span><br></pre></td></tr></table></figure>

<p>运行Gitaly</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gitlab_path=/home/git/gitlab</span><br><span class="line">gitaly_path=/home/git/gitaly</span><br><span class="line"></span><br><span class="line">sudo -u git -H sh -c <span class="string">"<span class="variable">$gitlab_path</span>/bin/daemon_with_pidfile <span class="variable">$gitlab_path</span>/tmp/pids/gitaly.pid <span class="variable">$gitaly_path</span>/gitaly <span class="variable">$gitaly_path</span>/config.toml &gt;&gt; <span class="variable">$gitlab_path</span>/log/gitaly.log 2&gt;&amp;1 &amp;"</span></span><br></pre></td></tr></table></figure>

<p>初始化数据库并激活高级功能</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/git/gitlab</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置GitLab密码为你自己的密码</span></span><br><span class="line">sudo -u git -H bundle <span class="built_in">exec</span> rake gitlab:setup RAILS_ENV=production GITLAB_ROOT_PASSWORD=yourpassword GITLAB_ROOT_EMAIL=youremail</span><br></pre></td></tr></table></figure>

<p>安装启动脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo cp lib/support/init.d/gitlab /etc/init.d/gitlab</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置开机自启</span></span><br><span class="line">sudo sysv-rc-conf gitlab on</span><br></pre></td></tr></table></figure>

<p>设置Logrotate</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp lib/support/logrotate/gitlab /etc/logrotate.d/gitlab</span><br></pre></td></tr></table></figure>

<p>检查GitLab及其环境是否配置正确</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u git -H bundle <span class="built_in">exec</span> rake gitlab:env:info RAILS_ENV=production</span><br></pre></td></tr></table></figure>

<p>编译GetText PO</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u git -H bundle <span class="built_in">exec</span> rake gettext:compile RAILS_ENV=production</span><br></pre></td></tr></table></figure>

<p>编译静态文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo -u git -H yarn install --production --pure-lockfile</span><br><span class="line">sudo -u git -H bundle <span class="built_in">exec</span> rake gitlab:assets:compile RAILS_ENV=production NODE_ENV=production NODE_OPTIONS=<span class="string">"--max_old_space_size=4096"</span></span><br></pre></td></tr></table></figure>

<p>启动GitLab</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo service gitlab start</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">sudo /etc/init.d/gitlab restart</span><br></pre></td></tr></table></figure>

<h3 id="9-NGINX"><a href="#9-NGINX" class="headerlink" title="9.NGINX"></a>9.NGINX</h3><p>NGINX是GitLab官方支持的Web服务器。安装NGINX并将GitLab的配置文件复制到NGINX的配置目录里，编辑相应文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HTTP</span></span><br><span class="line">sudo cp lib/support/nginx/gitlab /etc/nginx/sites-available/gitlab</span><br><span class="line"></span><br><span class="line"><span class="comment"># HTTPS</span></span><br><span class="line">sudo cp lib/support/nginx/gitlab-ssl /etc/nginx/sites-available/gitlab-ssl</span><br></pre></td></tr></table></figure>

<p>测试并重启NGINX。</p>
<h3 id="安装完成"><a href="#安装完成" class="headerlink" title="安装完成"></a>安装完成</h3><p>检查GitLab状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u git -H bundle <span class="built_in">exec</span> rake gitlab:check RAILS_ENV=production</span><br></pre></td></tr></table></figure>

<p>如果所有项目都是绿色，安装成功。</p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>打开<strong>ip</strong>或<strong>域名</strong>访问GitLab服务，进行后续配置。</p>
<p><img src="/images/install-gitlab.jpg" alt="GitLab"></p>
<p>其它问题可查询<a href="https://docs.gitlab.com/ee/install/installation.html#4-node" title="官方文档" target="_blank" rel="noopener">官方文档</a>。</p>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/GitLab/">GitLab</a></li></ul></footer></article><div class="comments" id="v-container"><script src="//unpkg.com/leancloud-storage@4.12.0/dist/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>new Valine({
  el: '#v-container',
  appId: 'u1yQ1lKVQjHyzschdLsKRXrP-MdYXbMMI',
  appKey: 'gity6FddlUlmP23K5mzPOUIP',
  avatar: 'wavatar',
  lang: 'zh-cn',
  placeholder: 'ヾﾉ≧∀≦)o来啊，造作啊!',
  serverURLs: 'https://u1yQ1lKV.api.lncldglobal.com',
  notify: false,
  verify: false,
  pageSize: 20,
  avatarForce: false,
  visitor: true,
  highlight: true
});</script></div></main><footer class="foot"><div class="foot-copy">&copy; 2019 - 2024 WeAir</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>