<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="WeAir"><link rel="alternative" href="/atom.xml" title="WeAir" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><title>部署Derp中继服务 - WeAir</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">WeAir</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">カタログ/（目录）</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time class="post__time" datetime="2024-11-30T04:00:00.000Z">November 30, 2024</time><h1 class="post__title"><a href="/install-derp/">部署Derp中继服务</a></h1><div class="post__main echo"><p><a href="https://tailscale.com/kb/1232/derp-servers" target="_blank" rel="noopener">Derp</a>是<a href="https://tailscale.com/" target="_blank" rel="noopener">Tailscale</a>自研的中继协议，用于在NAT打洞失败时帮助节点之间相互通信。</p>
<h3 id="部署Golang环境"><a href="#部署Golang环境" class="headerlink" title="部署Golang环境"></a>部署Golang环境</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://go.dev/dl/go1.23.3.linux-amd64.tar.gz -O /tmp/go1.23.3.linux-amd64.tar.gz</span><br><span class="line">tar -zxvf /tmp/go1.23.3.linux-amd64.tar.gz -C /usr/<span class="built_in">local</span></span><br><span class="line">ln -sf /usr/<span class="built_in">local</span>/go/bin/&#123;go,gofmt&#125; /usr/<span class="built_in">local</span>/bin</span><br><span class="line">rm -rf /tmp/go1.23.3.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="下载并编译安装Derp"><a href="#下载并编译安装Derp" class="headerlink" title="下载并编译安装Derp"></a>下载并编译安装Derp</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go install tailscale.com/cmd/derper@main</span><br><span class="line">\mv <span class="variable">$HOME</span>/go/bin/derper /usr/<span class="built_in">local</span>/bin</span><br></pre></td></tr></table></figure>

<h3 id="创建配置目录并添加相关证书"><a href="#创建配置目录并添加相关证书" class="headerlink" title="创建配置目录并添加相关证书"></a>创建配置目录并添加相关证书</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/derp</span><br><span class="line">touch /etc/derp/derp.conf</span><br><span class="line">\mv domain.name.&#123;crt,key&#125; /etc/derp</span><br></pre></td></tr></table></figure>

<h3 id="创建Systemd服务"><a href="#创建Systemd服务" class="headerlink" title="创建Systemd服务"></a>创建Systemd服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/systemd/system/derp.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Tailscale Derper</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=derper -a :12345 -c /etc/derp/derp.conf -certdir /etc/derp -certmode manual -hostname domain.name -http-port -1  -stun-port 54321</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="启动Derp服务"><a href="#启动Derp服务" class="headerlink" title="启动Derp服务"></a>启动Derp服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> --now derp.service</span><br></pre></td></tr></table></figure>

<h3 id="下载Derp配置文件并按需修改"><a href="#下载Derp配置文件并按需修改" class="headerlink" title="下载Derp配置文件并按需修改"></a>下载Derp配置文件并按需修改</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/juanfont/headscale/refs/heads/main/derp-example.yaml -O /etc/headscale/derp.yaml</span><br></pre></td></tr></table></figure>

<h3 id="修改Headscale配置"><a href="#修改Headscale配置" class="headerlink" title="修改Headscale配置"></a>修改Headscale配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">derp:</span><br><span class="line">  # server:</span><br><span class="line">    # enabled: false</span><br><span class="line">    # region_id: 999</span><br><span class="line">    # region_code: &quot;headscale&quot;</span><br><span class="line">    # region_name: &quot;Headscale Embedded DERP&quot;</span><br><span class="line">    # stun_listen_addr: &quot;0.0.0.0:3478&quot;</span><br><span class="line">    # private_key_path: /var/lib/headscale/derp_server_private.key</span><br><span class="line">    # automatically_add_embedded_derp_region: true</span><br><span class="line">    # ipv4: 1.2.3.4</span><br><span class="line">    # ipv6: 2001:db8::1</span><br><span class="line">  # urls:</span><br><span class="line">    # - https://controlplane.tailscale.com/derpmap/default</span><br><span class="line">  # paths: []</span><br><span class="line">  paths:</span><br><span class="line">    - /etc/headscale/derp.yaml</span><br><span class="line">  # auto_update_enabled: true</span><br><span class="line">  # update_frequency: 24h</span><br></pre></td></tr></table></figure>

<h3 id="重启Headscale服务载入配置"><a href="#重启Headscale服务载入配置" class="headerlink" title="重启Headscale服务载入配置"></a>重启Headscale服务载入配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart headscale.service</span><br></pre></td></tr></table></figure>

<h3 id="验证Derp服务"><a href="#验证Derp服务" class="headerlink" title="验证Derp服务"></a>验证Derp服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tailscale netcheck</span><br></pre></td></tr></table></figure>

<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>更多配置信息可查看<a href="https://tailscale.com/kb/1118/custom-derp-servers" target="_blank" rel="noopener">Tailscale</a>文档说明。</p>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/Headscale/">Headscale</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/Tailscale/">Tailscale</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/Derp/">Derp</a></li></ul></footer></article><div class="comments" id="v-container"><script src="//unpkg.com/leancloud-storage@4.12.0/dist/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>new Valine({
  el: '#v-container',
  appId: 'u1yQ1lKVQjHyzschdLsKRXrP-MdYXbMMI',
  appKey: 'gity6FddlUlmP23K5mzPOUIP',
  avatar: 'wavatar',
  lang: 'zh-cn',
  placeholder: 'ヾﾉ≧∀≦)o来啊，造作啊!',
  serverURLs: 'https://u1yQ1lKV.api.lncldglobal.com',
  notify: false,
  verify: false,
  pageSize: 20,
  avatarForce: false,
  visitor: true,
  highlight: true
});</script></div></main><footer class="foot"><div class="foot-copy">&copy; 2019 - 2024 WeAir</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>